<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>KC Money Management</title>
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.4/dist/chart.umd.min.js"></script>
  <style>
    :root {
      --bg:#0f0817; --card:#1a132b; --table:#1e1930; --hover:#2a2440;
      --text:#f0eaff; --muted:#b0a0d0; --border:#2a1f45;
      --primary:#a78bfa; --accent:#f472b6; --success:#86efac;
      --danger:#fca5a5; --warning:#fdba74; --info:#7dd3fc;
    }
    body { margin:0; font-family:system-ui,sans-serif; background:var(--bg); color:var(--text); min-height:100vh; }
    .container { max-width:1180px; margin:auto; padding:0 16px; }
    header { text-align:center; padding:28px 0 16px; }
    h1 { font-size:2.4rem; font-weight:700; color:var(--primary); margin-bottom:8px; }
    .controls { display:flex; flex-wrap:wrap; gap:16px; justify-content:center; margin:20px 0; }
    select, button { padding:10px 18px; font-size:1rem; border-radius:12px; border:1px solid var(--border); background:var(--card); color:var(--text); cursor:pointer; }
    button { background:linear-gradient(135deg,var(--primary),var(--accent)); border:none; font-weight:600; }
    button:hover { transform:translateY(-1px); }
    .card { background:var(--card); border:1px solid var(--border); border-radius:12px; box-shadow:0 10px 25px #0006; margin:24px 0; overflow:hidden; }
    .card-header { background:linear-gradient(135deg,#1e1438,#2a1f45); color:var(--primary); padding:14px; text-align:center; font-weight:600; }
    .card-body { padding:20px; }
    .summary-grid { display:grid; grid-template-columns:repeat(auto-fit,minmax(200px,1fr)); gap:14px; }
    .summary-item {
      background:rgba(40,30,60,.6); border-radius:10px; padding:14px; text-align:center;
      cursor:pointer; transition:.2s; border:1px solid #a78bfa20;
    }
    .summary-item:hover { background:rgba(50,40,70,.9); transform:scale(1.03); box-shadow:0 6px 16px #0008; }
    .summary-item strong { display:block; font-size:1.35rem; margin:6px 0; }
    .final-cash { font-size:1.8rem; font-weight:700; color:var(--accent); text-align:center; margin-top:20px; padding-top:16px; border-top:1px dashed #f472b650; }
    table { width:100%; border-collapse:separate; border-spacing:0 6px; margin-top:8px; }
    th,td { padding:12px 14px; }
    th { background:rgba(40,30,60,.8); color:var(--primary); }
    tr { background:var(--table); }
    tr:hover { background:var(--hover); }
    #chartCard { height:460px; }
    #loader { position:fixed; inset:0; background:#0a0512; display:flex; flex-direction:column; align-items:center; justify-content:center; font-size:2rem; color:var(--primary); z-index:9999; }
    #loader::after { content:""; width:70px; height:70px; border:8px solid var(--primary); border-top-color:transparent; border-radius:50%; animation:spin 1s linear infinite; margin-top:20px; }
    @keyframes spin { to{transform:rotate(360deg);} }
    #detailModal { display:none; position:fixed; inset:0; background:rgba(0,0,0,.85); z-index:10000; align-items:center; justify-content:center; }
    #detailContent { background:var(--card); border-radius:12px; width:90%; max-width:760px; max-height:85vh; overflow-y:auto; padding:20px; position:relative; box-shadow:0 15px 50px #000c; }
    .close-detail { position:absolute; top:10px; right:18px; font-size:40px; color:#fca5a5; cursor:pointer; }

   @keyframes spin { to { transform: rotate(360deg); } }
    #formModal {
      display: none;
      position: fixed;
      inset: 0;
      background: rgba(0,0,0,0.6);
      z-index: 10000;
      align-items: center;
      justify-content: center;
    }
    #formModal > div {
      background: white;
      border-radius: 12px;
      width: 92%;
      max-width: 640px;
      height: 88vh;
      position: relative;
      box-shadow: 0 10px 40px rgba(0,0,0,0.35);
    }
    .close-btn {
      position: absolute;
      top: 12px;
      right: 18px;
      font-size: 36px;
      color: #c62828;
      cursor: pointer;
      font-weight: bold;
    }
 
  </style>
</head>
<body>
<div id="loader">Loading…</div>
<div class="container">
  <header><h1>KC Money Management</h1></header>
  <div class="controls">
    <select id="day"></select>
<button onclick="document.getElementById('formModal').style.display='flex'">
  + Add Entry
</button>
<div id="formModal">
  <div>
    <span class="close-btn" onclick="document.getElementById('formModal').style.display='none'">×</span>
    <iframe src="./form.html" style="width:100%; height:100%; border:none;"></iframe>
  </div>
  </div>
  <div id="monthlyProfit" class="card" style="display:none">
    <div class="card-header">Summary</div>
    <div class="card-body">
      <div class="summary-grid" id="summaryGrid"></div>
      <div class="final-cash" id="finalCash"></div>
    </div>
  </div>
  <div id="chartCard" class="card" style="display:none">
    <div class="card-header">Trend</div>
    <canvas id="profitChart"></canvas>
  </div>
  <table id="dailyTable" class="card" style="display:none">
    <thead><tr><th>Desc</th><th>Type</th><th>Amt</th></tr></thead>
    <tbody></tbody>
  </table>
  <div id="dayBalance" style="display:none; text-align:center; font-size:1.35rem; margin:24px 0;"></div>
</div>
<!-- Detail Modal -->
<div id="detailModal">
  <div id="detailContent">
    <span class="close-detail" onclick="document.getElementById('detailModal').style.display='none'">×</span>
    <h2 id="detailTitle" style="margin:0 0 16px; color:var(--primary);"></h2>
    <table id="detailTable">
      <thead><tr><th>Date</th><th>Desc</th><th>Amt</th></tr></thead>
      <tbody></tbody>
    </table>
  </div>
</div>
<script>
const data = [];
let chart = null;
fetch("https://opensheet.elk.sh/1liis-IfyE7n9yeJV5osfqaRz0MMTz0UY9ijv3x5vEk8/ABC")
  .then(r => r.json())
  .then(rows => {
    rows.forEach(r => {
      const date = (r.Date || r.date || "").trim();
      const amt = Number(r["Amount (Rs.)"] || r.amount || 0);
      if (date && !isNaN(amt)) {
        data.push({
          date,
          desc: (r.Description || r.description || "").trim(),
          type: (r.Type || r.type || "").trim(),
          amount: amt
        });
      }
    });
    data.sort((a,b) => new Date(a.date) - new Date(b.date));
    document.getElementById("loader").style.display = "none";
    init();
  });
function init() {
  const s = document.getElementById("day");
  const dates = [...new Set(data.map(r => r.date))].sort((a,b) => new Date(b) - new Date(a));
  dates.forEach(d => s.add(new Option(d, d)));
  if (dates.length) s.value = dates[0];
  s.onchange = updateView;
  updateView();
}
function updateView() {
  const date = document.getElementById("day").value;
  if (!date) return;
  // Daily table
  const tb = document.querySelector("#dailyTable tbody");
  tb.innerHTML = "";
  const day = data.filter(r => r.date === date);
  let net = 0;
  day.forEach(i => {
    const cls = i.type.toLowerCase().replace(/\s+/g, "-");
    tb.innerHTML += `<tr><td>${i.desc || "—"}</td><td class="${cls}">${i.type}</td><td class="${cls}">${i.amount.toFixed(2)}</td></tr>`;
    net += i.type === "Income" ? i.amount : (["Expenses", "In-shop Expenses", "Missing", "BOC Deposit", "Investment"].includes(i.type) ? -i.amount : 0);
  });
  const b = document.getElementById("dayBalance");
  b.textContent = `${date} අවසාන ලාභය: Rs. ${net.toFixed(2)}`;
  b.style.display = day.length ? "block" : "none";
  document.getElementById("dailyTable").style.display = day.length ? "table" : "none";
  const up = new Date(date);
  const past = data.filter(r => new Date(r.date) <= up);
  if (!past.length) {
    document.getElementById("monthlyProfit").innerHTML = '<div style="padding:50px;text-align:center;color:#aaa">No data</div>';
    document.getElementById("monthlyProfit").style.display = "block";
    document.getElementById("chartCard").style.display = "none";
    return;
  }
  // Monthly summary
  const m = past.reduce((o, r) => {
    const k = r.date.slice(0, 7);
    o[k] = (o[k] || []).concat(r);
    return o;
  }, {});
  const ks = Object.keys(m).sort();
  let carry = 0, prev = "";
  ks.slice(0, -1).forEach(k => { carry += monthNet(m[k]); prev = k; });
  const cur = m[ks.at(-1)];
  const hand = carry + monthNet(cur);
  const grid = document.getElementById("summaryGrid");
  grid.innerHTML = `
    ${prev ? `<div class="summary-item" data-category="carry" data-prev="${prev}" data-carry="${carry}">
      <div>Carry (${prev})</div><strong style="color:#a5b4fc">Rs.${carry.toFixed(2)}</strong></div>` : ""}
    <div class="summary-item" data-category="Income">
      <div>Income</div><strong class="income">Rs.${byType(cur,'Income').toFixed(2)}</strong></div>
    <div class="summary-item" data-category="Expenses">
      <div>Expenses</div><strong class="expenses">Rs.${byType(cur,['Expenses','In-shop Expenses']).toFixed(2)}</strong></div>
    <div class="summary-item" data-category="Missing">
      <div>Missing</div><strong class="missing">Rs.${byType(cur,'Missing').toFixed(2)}</strong></div>
    <div class="summary-item" data-category="Investment">
      <div>Investment</div><strong class="investment">Rs.${byType(cur,'Investment').toFixed(2)}</strong></div>
    <div class="summary-item" data-category="BOC/RDB Deposit">
      <div>BOC/RDB</div><strong class="boc deposit">Rs.${byType(cur,['BOC Deposit','RDB Deposit']).toFixed(2)}</strong></div>
  `;
  // Add click listeners after rendering
  document.querySelectorAll('.summary-item').forEach(item => {
    item.onclick = () => {
      const cat = item.dataset.category;
      let filtered = [];
      if (cat === "carry") {
        const prevMonthEnd = new Date(prev + "-01");
        prevMonthEnd.setMonth(prevMonthEnd.getMonth());
        prevMonthEnd.setDate(0); // last day of prev month
        filtered = past.filter(r => new Date(r.date) <= prevMonthEnd);
      } else if (cat === "Expenses") {
        filtered = past.filter(r => r.type === 'Expenses' || r.type === 'In-shop Expenses');
      } else if (cat === "BOC/RDB Deposit") {
        filtered = past.filter(r => r.type === 'BOC Deposit' || r.type === 'RDB Deposit');
      } else {
        filtered = past.filter(r => r.type === cat);
      }
      showCat(cat === "carry" ? `Carry forward (${prev})` : cat, filtered);
    };
  });
  document.getElementById("finalCash").textContent = `Hand Cash: Rs.${hand.toFixed(2)}`;
  document.getElementById("monthlyProfit").style.display = "block";
  // Chart part (unchanged, shortened)
  const dn = past.reduce((o,r) => {
    o[r.date] = (o[r.date] || 0) + (r.type==="Income" ? r.amount : (["Expenses","In-shop Expenses","Missing","BOC Deposit","RDB Deposit","Investment"].includes(r.type) ? -r.amount : 0));
    return o;
  }, {});
  const ds = Object.keys(dn).sort();
  const vs = ds.map(k=>dn[k]);
  let tot = 0;
  const cu = vs.map(v => tot += v);
  document.getElementById("chartCard").style.display = "block";
  if (chart) {
    chart.data.labels = ds;
    chart.data.datasets[0].data = cu;
    chart.data.datasets[1].data = vs;
    chart.update();
    return;
  }
  chart = new Chart(document.getElementById("profitChart"), {
    type: "line",
    data: {
      labels: ds,
      datasets: [
        { label: "Cumulative", data: cu, borderColor: "#a78bfa", backgroundColor: "#a78bfa20", fill: true, tension: .38, yAxisID: "y" },
        { label: "Daily", data: vs, borderColor: "#f472b6", borderDash: [5,3], tension: .25, yAxisID: "y1" }
      ]
    },
    options: {
      responsive: true,
      maintainAspectRatio: false,
      plugins: { legend: { position: "top", labels: { color: "#d1d5db" } } },
      scales: {
        y: { position: "left", title: { display: true, text: "Cumulative", color: "#d1d5db" }, ticks: { color: "#b0a0d0" } },
        y1: { position: "right", title: { display: true, text: "Daily", color: "#d1d5db" }, grid: { drawOnChartArea: false }, ticks: { color: "#b0a0d0" } }
      }
    }
  });
}
function showCat(title, items) {
  document.getElementById("detailTitle").textContent = title;
  const tb = document.querySelector("#detailTable tbody");
  tb.innerHTML = items.map(r => `<tr><td>${r.date}</td><td>${r.desc || "-"}</td><td>${r.amount.toFixed(2)}</td></tr>`).join("");
  document.getElementById("detailModal").style.display = "flex";
}
function byType(items, types) {
  const t = [].concat(types);
  return items.filter(r => t.includes(r.type)).reduce((s, r) => s + r.amount, 0);
}
function monthNet(items) {
  return byType(items, "Income") -
         byType(items, ["Expenses", "In-shop Expenses"]) -
         byType(items, "Missing") -
         byType(items, ["BOC Deposit", "RDB Deposit"]) -
         byType(items, "Investment");
}
</script>
</body>
</html>

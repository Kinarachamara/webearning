<!DOCTYPE html>
<html lang="si">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no"/>
  <title>KC Money Management</title>
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.4/dist/chart.umd.min.js"></script>
  <style>
    :root {
      --bg: #0a0512;
      --card: rgba(21,15,36,0.94);
      --table: #1c1630;
      --hover: #2a2440;
      --text: #f0eaff;
      --muted: #b0a0d0;
      --border: rgba(58,47,85,0.7);
      --primary: #a78bfa;
      --accent: #f472b6;
      --success: #34d399;
      --danger: #f87171;
      --warning: #fbbf24;
      --info: #60a5fa;
      --glass: rgba(30,20,60,0.52);
      --glass-border: rgba(167,139,250,0.26);
      --shadow: 0 10px 32px rgba(0,0,0,0.55);
    }

    * { box-sizing:border-box; margin:0; padding:0; }
    body {
      font-family: system-ui, -apple-system, sans-serif;
      background: linear-gradient(145deg, var(--bg), #0d071a);
      color: var(--text);
      min-height: 100vh;
      -webkit-font-smoothing: antialiased;
    }

    .container { max-width:1280px; margin:0 auto; padding:0 1rem; }

    header { text-align:center; padding:1.8rem 0 1.2rem; }

    h1 {
      font-size: clamp(2.2rem, 9vw, 3.5rem);
      font-weight:800;
      background: linear-gradient(90deg, var(--primary), var(--accent));
      -webkit-background-clip:text;
      background-clip:text;
      color:transparent;
    }

    .controls {
      display:flex; flex-wrap:wrap; gap:0.9rem;
      justify-content:center; margin:1.5rem 0;
    }

    .controls > * {
      padding:0.95rem 1.4rem; font-size:1rem;
      border-radius:1rem; border:1px solid var(--border);
      background:var(--card); color:var(--text);
      min-height:52px; transition:all 0.2s;
    }

    select:focus, input:focus {
      outline:none; border-color:var(--primary);
      box-shadow:0 0 0 4px rgba(167,139,250,0.3);
    }

    button {
      background:linear-gradient(135deg,var(--primary),var(--accent));
      border:none; font-weight:700; cursor:pointer;
    }

    button:active { transform:scale(0.98); }

    .card {
      background:var(--glass);
      backdrop-filter:blur(12px);
      border:1px solid var(--glass-border);
      border-radius:1.4rem;
      box-shadow:var(--shadow);
      margin:1.6rem 0; overflow:hidden;
    }

    .card-header {
      background:linear-gradient(135deg,#1e1438,#2a1f45);
      padding:1.1rem; text-align:center;
      font-weight:700; font-size:1.3rem;
      color:var(--primary);
    }

    .summary-grid {
      display:grid;
      grid-template-columns:repeat(auto-fit,minmax(180px,1fr));
      gap:1.1rem; padding:1.4rem;
    }

    .summary-item {
      background:rgba(50,40,80,0.6);
      border-radius:1rem; padding:1.3rem 1rem;
      text-align:center; cursor:pointer;
      transition:all 0.3s; border:1px solid rgba(167,139,250,0.2);
    }

    .summary-item:hover {
      transform:translateY(-6px);
      box-shadow:0 14px 34px rgba(0,0,0,0.5);
    }

    .summary-item strong { font-size:clamp(1.4rem,5.5vw,1.8rem); margin:0.5rem 0; }

    .final-cash {
      font-size:clamp(1.9rem,7vw,2.5rem);
      font-weight:800; text-align:center;
      margin:1.5rem 1rem; padding:1.3rem;
      background:rgba(20,30,50,0.5);
      border-radius:1.2rem;
      border:1.5px dashed var(--accent);
    }

    table {
      width:100%; border-collapse:separate; border-spacing:0 0.5rem;
      margin-top:0.6rem;
    }

    th,td { padding:0.9rem 1rem; text-align:left; font-size:0.95rem; }

    th { background:rgba(50,40,80,0.8); color:var(--primary); font-weight:600; }

    tr { background:var(--table); transition:0.2s; }
    tr:hover { background:var(--hover); }

    .desc-cell {
      max-width:0; overflow:hidden;
      text-overflow:ellipsis; white-space:nowrap;
    }

    .type-income { color:var(--success); font-weight:600; }
    .type-expense, .type-in-shop-expenses, .type-missing { color:var(--danger); }
    .type-investment, .type-boc-deposit, .type-rdb-deposit { color:var(--warning); }

    #searchInput { width:100%; max-width:400px; }

    #exportBtn { background:linear-gradient(135deg,#10b981,#34d399); }

    #chartContainer {
      display:grid; grid-template-columns:1fr; gap:1.6rem;
      padding:1.4rem 0.8rem;
    }

    #chartContainer > div { height:360px; min-height:300px; }

    #loader {
      position:fixed; inset:0;
      background:var(--bg);
      display:flex; flex-direction:column;
      align-items:center; justify-content:center;
      font-size:2.8rem; color:var(--primary);
      z-index:9999;
    }

    .spinner {
      width:80px; height:80px;
      border:10px solid var(--primary);
      border-top-color:transparent;
      border-radius:50%;
      animation:spin 1s linear infinite;
      margin-top:1.5rem;
    }

    @keyframes spin { to { transform:rotate(360deg); } }

    #formModal, #detailModal {
      display:none; position:fixed; inset:0;
      background:rgba(0,0,0,0.88); z-index:10000;
      align-items:center; justify-content:center;
      backdrop-filter:blur(6px);
    }

    #formModal > div, #detailContent {
      background:var(--card); border-radius:1.4rem;
      width:94%; max-width:860px; max-height:90vh;
      overflow-y:auto; padding:1.6rem; position:relative;
      box-shadow:var(--shadow); border:1px solid var(--border);
    }

    .close-btn {
      position:absolute; top:0.8rem; right:1.2rem;
      font-size:3.2rem; color:var(--danger); cursor:pointer;
    }

    /* Form */
    #formModal h2 { text-align:center; color:var(--primary); margin-bottom:1.6rem; }

    #formModal label { display:block; margin:0.8rem 0 0.4rem; color:var(--muted); font-weight:500; }

    #formModal input, #formModal select {
      width:100%; padding:0.95rem; margin-bottom:1rem;
      background:rgba(40,30,70,0.7); border:1px solid #4a3a7a;
      border-radius:0.9rem; color:var(--text); font-size:1.05rem;
    }

    #formModal .actions { display:flex; gap:1rem; margin-top:1.8rem; }

    #formModal button { flex:1; padding:1.1rem; font-size:1.1rem; border-radius:1rem; }

    #formModal .cancel-btn { background:var(--muted); }

    /* Responsive */
    @media (max-width:640px) {
      .controls { flex-direction:column; }
      .controls > * { width:100%; }
      .summary-grid { grid-template-columns:1fr; }
      table { font-size:0.92rem; }
      th,td { padding:0.8rem 0.7rem; }
      .desc-cell { max-width:120px; }
      #chartContainer > div { height:320px; }
    }

    @media (min-width:769px) {
      #chartContainer { grid-template-columns:1fr 1fr; }
      #chartContainer > div { height:420px; }
    }
  </style>
</head>
<body>

<div id="loader">KC Money Management<br><div class="spinner"></div></div>

<div class="container">
  <header><h1>KC Money Management</h1></header>

  <div class="controls">
    <select id="day"></select>
    <input type="text" id="searchInput" placeholder="‡∑Ä‡∑í‡∑É‡∑ä‡∂≠‡∂ª‡∂∫ ‡∑É‡∑ú‡∂∫‡∂±‡∑ä‡∂±..." />
    <button onclick="document.getElementById('formModal').style.display='flex'">+ ‡∂á‡∂≠‡∑î‡∂Ω‡∂≠‡∑ä ‡∂ö‡∂ª‡∂±‡∑ä‡∂±</button>
    <button id="exportBtn">Export CSV</button>
  </div>

  <!-- Add Entry Modal -->
  <div id="formModal">
    <div>
      <span class="close-btn" onclick="document.getElementById('formModal').style.display='none'">√ó</span>
      <h2>‡∂±‡∑Ä ‡∂ú‡∂±‡∑î‡∂Ø‡∑ô‡∂±‡∑î‡∑Ä‡∂ö‡∑ä ‡∂á‡∂≠‡∑î‡∂Ω‡∂≠‡∑ä ‡∂ö‡∂ª‡∂±‡∑ä‡∂±</h2>

      <label for="newDate">‡∂Ø‡∑í‡∂±‡∂∫</label>
      <input type="date" id="newDate">

      <label for="newType">‡∑Ä‡∂ª‡∑ä‡∂ú‡∂∫</label>
      <select id="newType">
        <option value="Income">Income</option>
        <option value="Expenses">Expenses</option>
        <option value="In-shop Expenses">In-shop Expenses</option>
        <option value="Missing">Missing</option>
        <option value="BOC Deposit">BOC Deposit</option>
        <option value="RDB Deposit">RDB Deposit</option>
        <option value="Investment">Investment</option>
      </select>

      <label for="newDesc">‡∑Ä‡∑í‡∑É‡∑ä‡∂≠‡∂ª‡∂∫</label>
      <input list="descSuggestions" id="newDesc" placeholder="‡∑Ä‡∑í‡∑É‡∑ä‡∂≠‡∂ª‡∂∫ ‡∂á‡∂≠‡∑î‡∂Ω‡∂≠‡∑ä ‡∂ö‡∂ª‡∂±‡∑ä‡∂±">

      <datalist id="descSuggestions"></datalist>

      <label for="newAmount">‡∂∏‡∑î‡∂Ø‡∂Ω‡∑ä ‡∂¥‡∑ä‚Äç‡∂ª‡∂∏‡∑è‡∂´‡∂∫ (Rs.)</label>
      <input type="number" id="newAmount" placeholder="0.00" step="0.01">

      <div class="actions">
        <button onclick="saveNewEntry()">‡∑É‡∑ö‡∑Ä‡∑ä ‡∂ö‡∂ª‡∂±‡∑ä‡∂±</button>
        <button class="cancel-btn" onclick="document.getElementById('formModal').style.display='none'">‡∂Ö‡∂≠‡∑ä‡∑Ñ‡∂ª‡∑í‡∂±‡∑ä‡∂±</button>
      </div>
    </div>
  </div>

  <div id="monthlyProfit" class="card" style="display:none">
    <div class="card-header">‡∂∏‡∑è‡∑É‡∑í‡∂ö ‡∑É‡∑è‡∂ª‡∑è‡∂Ç‡∑Å‡∂∫</div>
    <div class="summary-grid" id="summaryGrid"></div>
    <div class="final-cash" id="finalCash"></div>
  </div>

  <div id="chartsSection" class="card" style="display:none">
    <div class="card-header">‡∂¥‡∑ä‚Äç‡∂ª‡∑Ä‡∂´‡∂≠‡∑è ‡∑Ñ‡∑è ‡∑Ä‡∂ª‡∑ä‡∂ú‡∑ì‡∂ö‡∂ª‡∂´‡∂∫</div>
    <div id="chartContainer">
      <div><canvas id="profitChart"></canvas></div>
      <div><canvas id="pieChart"></canvas></div>
    </div>
  </div>

  <div class="card" id="dailySection" style="display:none">
    <div class="card-header">‡∂Ø‡∑õ‡∂±‡∑í‡∂ö ‡∂á‡∂≠‡∑î‡∑Ö‡∂≠‡∑ä ‡∂ö‡∑í‡∂ª‡∑ì‡∂∏‡∑ä</div>
    <div style="padding:0 12px 16px;">
      <table id="dailyTable">
        <thead><tr><th>‡∂Ø‡∑Ä‡∑É</th><th>‡∑Ä‡∑í‡∑É‡∑ä‡∂≠‡∂ª‡∂∫</th><th>‡∑Ä‡∂ª‡∑ä‡∂ú‡∂∫</th><th>‡∂∏‡∑î‡∂Ø‡∂Ω‡∑ä (Rs.)</th></tr></thead>
        <tbody></tbody>
      </table>
    </div>
  </div>

  <div id="dayBalance" style="display:none; text-align:center; font-size:1.5rem; margin:28px 0; font-weight:700;"></div>
</div>

<!-- Detail Modal -->
<div id="detailModal">
  <div id="detailContent">
    <span class="close-btn" onclick="document.getElementById('detailModal').style.display='none'">√ó</span>
    <h2 id="detailTitle" style="margin:0 0 20px; color:var(--primary); text-align:center;"></h2>
    <table id="detailTable">
      <thead><tr><th>‡∂Ø‡∑Ä‡∑É</th><th>‡∑Ä‡∑í‡∑É‡∑ä‡∂≠‡∂ª‡∂∫</th><th>‡∂∏‡∑î‡∂Ø‡∂Ω‡∑ä</th></tr></thead>
      <tbody></tbody>
    </table>
  </div>
</div>

<script>
const data = [];
let profitChart = null, pieChart = null;

const SHEET_URL = "https://opensheet.elk.sh/1liis-IfyE7n9yeJV5osfqaRz0MMTz0UY9ijv3x5vEk8/ABC";
const API_URL   = "https://script.google.com/macros/s/AKfycbwugmgdPPSwILCjVwVmSyzPlUeha8ubf08FVQwZE8HsyHNHkA2YUiR4DNIe6igM3M9F/exec";

fetch(SHEET_URL)
  .then(r => r.json())
  .then(rows => {
    rows.forEach(r => {
      const date = (r.Date || r.date || "").trim();
      const amt  = Number(r["Amount (Rs.)"] || r.amount || 0);
      if (date && !isNaN(amt)) {
        data.push({
          date,
          desc: (r.Description || r.description || "").trim(),
          type: (r.Type || r.type || "").trim(),
          amount: amt
        });
      }
    });
    data.sort((a,b) => new Date(a.date) - new Date(b.date));
    document.getElementById("loader").style.display = "none";
    init();
  });

// ‚îÄ‚îÄ Form helpers ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function loadDescriptionSuggestions() {
  fetch(API_URL)
    .then(r => r.json())
    .then(list => {
      const datalist = document.getElementById("descSuggestions");
      datalist.innerHTML = "";
      list.forEach(d => {
        const opt = document.createElement("option");
        opt.value = d;
        datalist.appendChild(opt);
      });
    })
    .catch(() => {});
}

document.addEventListener("DOMContentLoaded", () => {
  document.getElementById("newDate").value = new Date().toISOString().split("T")[0];
  loadDescriptionSuggestions();
});

function saveNewEntry() {
  const date   = document.getElementById("newDate").value;
  const type   = document.getElementById("newType").value;
  const desc   = document.getElementById("newDesc").value.trim();
  const amount = document.getElementById("newAmount").value;

  if (!date || !type || !desc || !amount || Number(amount) <= 0) {
    alert("‡∂ö‡∂ª‡∑î‡∂´‡∑è‡∂ö‡∂ª ‡∑É‡∑í‡∂∫‡∂Ω‡∑î ‡∂ö‡∑ú‡∂ß‡∑É‡∑ä ‡∑Ñ‡∂ª‡∑í‡∂∫‡∂ß ‡∂¥‡∑î‡∂ª‡∑Ä‡∂±‡∑ä‡∂±");
    return;
  }

  fetch(API_URL, {
    method: "POST",
    mode: "no-cors",
    headers: { "Content-Type": "application/json" },
    body: JSON.stringify({ date, description: desc, type, amount })
  })
  .then(() => {
    alert("‚úÖ ‡∂á‡∂≠‡∑î‡∂Ω‡∂≠‡∑ä ‡∂ö‡∑í‡∂ª‡∑ì‡∂∏ ‡∑É‡∑è‡∂ª‡∑ä‡∂Æ‡∂ö‡∂∫‡∑í!");
    document.getElementById("formModal").style.display = "none";
    location.reload();
  })
  .catch(() => alert("‡∑É‡∑ö‡∑Ä‡∑ä ‡∑Ä‡∑ì‡∂∏ ‡∂Ö‡∑É‡∑è‡∂ª‡∑ä‡∂Æ‡∂ö‡∂∫‡∑í ‚Äì ‡∂∫‡∑Ö‡∑í ‡∂ã‡∂≠‡∑ä‡∑É‡∑è‡∑Ñ ‡∂ö‡∂ª‡∂±‡∑ä‡∂±"));
}

// ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function init() {
  const s = document.getElementById("day");
  const dates = [...new Set(data.map(r => r.date))].sort((a,b) => new Date(b) - new Date(a));
  dates.forEach(d => s.add(new Option(d, d)));
  if (dates.length) s.value = dates[0];
  s.onchange = updateView;
  document.getElementById("searchInput").oninput = updateView;
  document.getElementById("exportBtn").onclick = exportCSV;
  updateView();
}

function updateView() {
  const selectedDate = document.getElementById("day").value;
  const searchTerm = document.getElementById("searchInput").value.toLowerCase().trim();
  if (!selectedDate) return;

  // Daily table
  const tb = document.querySelector("#dailyTable tbody");
  tb.innerHTML = "";
  const dayEntries = data.filter(r => r.date === selectedDate);
  const filtered = searchTerm
    ? dayEntries.filter(r => r.desc.toLowerCase().includes(searchTerm) || r.type.toLowerCase().includes(searchTerm))
    : dayEntries;

  let net = 0;
  filtered.forEach(i => {
    const cls = `type-${i.type.toLowerCase().replace(/\s+/g,"-")}`;
    tb.innerHTML += `
      <tr>
        <td>${i.date}</td>
        <td class="desc-cell">${i.desc || "‚Äî"}</td>
        <td class="${cls}">${i.type}</td>
        <td class="${cls}">${i.amount.toLocaleString('si-LK',{minimumFractionDigits:2})}</td>
      </tr>`;
    net += i.type === "Income" ? i.amount : (["Expenses","In-shop Expenses","Missing","BOC Deposit","RDB Deposit","Investment"].includes(i.type) ? -i.amount : 0);
  });

  const balEl = document.getElementById("dayBalance");
  balEl.textContent = `${selectedDate} ‡∂Ö‡∑Ä‡∑É‡∑è‡∂± ‡∂Ω‡∑è‡∂∑‡∂∫: Rs. ${net.toLocaleString('si-LK',{minimumFractionDigits:2})}`;
  balEl.className = net >= 0 ? "profit-positive" : "profit-negative";
  balEl.style.display = filtered.length ? "block" : "none";
  document.getElementById("dailySection").style.display = filtered.length ? "block" : "none";

  // Cumulative up to selected date
  const upToDate = new Date(selectedDate);
  const past = data.filter(r => new Date(r.date) <= upToDate);

  if (!past.length) {
    document.getElementById("monthlyProfit").innerHTML = '<div style="padding:80px;text-align:center;color:#777">‡∂≠‡∑Ä‡∂∏ data ‡∂±‡∑ê‡∂≠...</div>';
    document.getElementById("monthlyProfit").style.display = "block";
    return;
  }

  const months = past.reduce((o,r) => {
    const k = r.date.slice(0,7);
    o[k] = (o[k] || []).concat(r);
    return o;
  }, {});

  const monthKeys = Object.keys(months).sort();
  let carry = 0;
  let prevMonth = "";
  monthKeys.slice(0,-1).forEach(k => {
    carry += monthNet(months[k]);
    prevMonth = k;
  });

  const currMonth = months[monthKeys.at(-1)];
  const handCash = carry + monthNet(currMonth);

  // Summary grid
  const grid = document.getElementById("summaryGrid");
  grid.innerHTML = `
    ${prevMonth ? `
    <div class="summary-item" onclick="showDetail('Carry forward (${prevMonth})', past.filter(r => new Date(r.date) <= new Date('${prevMonth}-01').setDate(0)))">
      <div>Carry Forward (${prevMonth})</div>
      <strong style="color:#a5b4fc">Rs.${carry.toLocaleString('si-LK',{minimumFractionDigits:2})}</strong>
    </div>` : ""}
    <div class="summary-item" onclick="showDetail('Income', past.filter(r => r.type==='Income'))">
      <div>üí∞ Income</div><strong class="profit-positive">Rs.${byType(currMonth,'Income').toLocaleString('si-LK',{minimumFractionDigits:2})}</strong>
    </div>
    <div class="summary-item" onclick="showDetail('Expenses', past.filter(r => ['Expenses','In-shop Expenses'].includes(r.type)))">
      <div>üí∏ Expenses</div><strong style="color:var(--danger)">Rs.${byType(currMonth,['Expenses','In-shop Expenses']).toLocaleString('si-LK',{minimumFractionDigits:2})}</strong>
    </div>
    <div class="summary-item" onclick="showDetail('Missing', past.filter(r => r.type==='Missing'))">
      <div>‚ö†Ô∏è Missing</div><strong style="color:var(--warning)">Rs.${byType(currMonth,'Missing').toLocaleString('si-LK',{minimumFractionDigits:2})}</strong>
    </div>
    <div class="summary-item" onclick="showDetail('Investment', past.filter(r => r.type==='Investment'))">
      <div>üìà Investment</div><strong style="color:var(--warning)">Rs.${byType(currMonth,'Investment').toLocaleString('si-LK',{minimumFractionDigits:2})}</strong>
    </div>
    <div class="summary-item" onclick="showDetail('BOC/RDB', past.filter(r => ['BOC Deposit','RDB Deposit'].includes(r.type)))">
      <div>üè¶ BOC/RDB</div><strong style="color:var(--info)">Rs.${byType(currMonth,['BOC Deposit','RDB Deposit']).toLocaleString('si-LK',{minimumFractionDigits:2})}</strong>
    </div>
  `;

  document.getElementById("finalCash").innerHTML = `Hand Cash: <span class="${handCash >= 0 ? 'profit-positive' : 'profit-negative'}">Rs.${handCash.toLocaleString('si-LK',{minimumFractionDigits:2})}</span>`;
  document.getElementById("monthlyProfit").style.display = "block";

  updateCharts(past, currMonth);
  document.getElementById("chartsSection").style.display = "block";
}

function updateCharts(allData, currMonthData) {
  const dailyNet = allData.reduce((o,r) => {
    const sign = r.type==="Income" ? 1 : (["Expenses","In-shop Expenses","Missing","BOC Deposit","RDB Deposit","Investment"].includes(r.type) ? -1 : 0);
    o[r.date] = (o[r.date] || 0) + sign * r.amount;
    return o;
  }, {});

  const labels = Object.keys(dailyNet).sort();
  const dailyValues = labels.map(k => dailyNet[k]);
  let cum = 0;
  const cumValues = dailyValues.map(v => cum += v);

  if (profitChart) {
    profitChart.data.labels = labels;
    profitChart.data.datasets[0].data = cumValues;
    profitChart.data.datasets[1].data = dailyValues;
    profitChart.update();
  } else {
    profitChart = new Chart(document.getElementById("profitChart"), {
      type: "line",
      data: {
        labels,
        datasets: [
          { label: "Cumulative", data: cumValues, borderColor: "#a78bfa", backgroundColor: "rgba(167,139,250,0.15)", fill: true, tension: 0.35, yAxisID: "y" },
          { label: "Daily Net", data: dailyValues, borderColor: "#f472b6", borderDash: [6,4], tension: 0.28, yAxisID: "y1" }
        ]
      },
      options: {
        responsive: true,
        maintainAspectRatio: false,
        plugins: { legend: { position: "top", labels: { color: "#d1d5db" } } },
        scales: {
          x: { ticks: { color: "#b0a0d0" } },
          y: { position: "left", title: { display: true, text: "Cumulative (Rs.)", color: "#d1d5db" }, ticks: { color: "#b0a0d0" } },
          y1: { position: "right", title: { display: true, text: "Daily Net", color: "#d1d5db" }, grid: { drawOnChartArea: false }, ticks: { color: "#b0a0d0" } }
        }
      }
    });
  }

  // Pie
  const catSums = {};
  currMonthData.forEach(r => {
    const t = r.type;
    catSums[t] = (catSums[t] || 0) + (t === "Income" ? r.amount : -r.amount);
  });

  const pieData = Object.entries(catSums).map(([label, value]) => ({label, value: Math.abs(value)}));
  const colors = ["#34d399","#f87171","#fbbf24","#60a5fa","#a78bfa","#f472b6","#ec4899"];

  if (pieChart) {
    pieChart.data.labels = pieData.map(d => d.label);
    pieChart.data.datasets[0].data = pieData.map(d => d.value);
    pieChart.update();
  } else {
    pieChart = new Chart(document.getElementById("pieChart"), {
      type: "doughnut",
      data: {
        labels: pieData.map(d => d.label),
        datasets: [{
          data: pieData.map(d => d.value),
          backgroundColor: colors,
          borderColor: "rgba(30,20,60,0.8)",
          borderWidth: 2
        }]
      },
      options: {
        responsive: true,
        maintainAspectRatio: false,
        plugins: {
          legend: { position: "bottom", labels: { color: "#d1d5db", padding: 16 } },
          title: { display: true, text: "‡∂∏‡∑è‡∑É‡∑í‡∂ö ‡∑Ä‡∂ª‡∑ä‡∂ú‡∑ì‡∂ö‡∂ª‡∂´‡∂∫", color: "#f0eaff", font: { size: 16 } }
        },
        cutout: "60%"
      }
    });
  }
}

function showDetail(title, items) {
  document.getElementById("detailTitle").textContent = title;
  const tb = document.querySelector("#detailTable tbody");
  tb.innerHTML = items.map(r => `
    <tr>
      <td>${r.date}</td>
      <td class="desc-cell">${r.desc || "‚Äî"}</td>
      <td>${r.amount.toLocaleString('si-LK',{minimumFractionDigits:2})}</td>
    </tr>`).join("");
  document.getElementById("detailModal").style.display = "flex";
}

function byType(items, types) {
  const t = [].concat(types);
  return items.filter(r => t.includes(r.type)).reduce((s,r) => s + r.amount, 0);
}

function monthNet(items) {
  return byType(items, "Income") -
         byType(items, ["Expenses", "In-shop Expenses"]) -
         byType(items, "Missing") -
         byType(items, ["BOC Deposit", "RDB Deposit"]) -
         byType(items, "Investment");
}

function exportCSV() {
  const selected = document.getElementById("day").value;
  if (!selected) return alert("‡∂ö‡∂ª‡∑î‡∂´‡∑è‡∂ö‡∂ª ‡∂Ø‡∑Ä‡∑É‡∂ö‡∑ä ‡∂≠‡∑ù‡∂ª‡∂±‡∑ä‡∂±");
  const month = selected.slice(0,7);
  const monthData = data.filter(r => r.date.startsWith(month));
  if (!monthData.length) return alert("‡∂∏‡∑ö ‡∂∏‡∑è‡∑É‡∂∫‡∑ö ‡∂Ø‡∂≠‡∑ä‡∂≠ ‡∂±‡∑ê‡∂≠");

  let csv = "Date,Description,Type,Amount (Rs.)\n";
  monthData.forEach(r => {
    csv += `"${r.date}","${r.desc.replace(/"/g,'""')}","${r.type}",${r.amount}\n`;
  });

  const blob = new Blob([csv], {type:"text/csv;charset=utf-8;"});
  const url = URL.createObjectURL(blob);
  const a = document.createElement("a");
  a.href = url;
  a.download = `KC_Money_${month}.csv`;
  a.click();
  URL.revokeObjectURL(url);
}
</script>
</body>
</html>

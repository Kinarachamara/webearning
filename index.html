<!DOCTYPE html>
<html lang="si">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>KC Money Management</title>
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.4/dist/chart.umd.min.js"></script>
  <style>
    :root {
      --bg: #0a0512;
      --card: #150f24;
      --table: #1c1630;
      --hover: #2a2440;
      --text: #f0eaff;
      --muted: #b0a0d0;
      --border: #3a2f55;
      --primary: #a78bfa;
      --primary-dark: #7c3aed;
      --accent: #f472b6;
      --success: #34d399;
      --danger: #f87171;
      --warning: #fbbf24;
      --info: #60a5fa;
      --glass: rgba(30, 20, 60, 0.4);
      --glass-border: rgba(167, 139, 250, 0.18);
    }
    * { box-sizing:border-box; }
    body {
      margin:0;
      font-family: system-ui, -apple-system, sans-serif;
      background: linear-gradient(135deg, var(--bg), #120b1f);
      color: var(--text);
      min-height: 100vh;
    }
    .container { max-width: 1200px; margin: auto; padding: 0 16px; }
    header { text-align: center; padding: 32px 0 16px; }
    h1 {
      font-size: 2.8rem;
      font-weight: 800;
      background: linear-gradient(90deg, var(--primary), var(--accent));
      -webkit-background-clip: text;
      background-clip: text;
      color: transparent;
      margin: 0;
    }
    .controls {
      display: flex;
      flex-wrap: wrap;
      gap: 12px;
      justify-content: center;
      margin: 24px 0;
    }
    select, button, input {
      padding: 12px 20px;
      font-size: 1rem;
      border-radius: 12px;
      border: 1px solid var(--border);
      background: var(--card);
      color: var(--text);
      transition: all 0.2s;
    }
    select:focus, input:focus { outline: none; border-color: var(--primary); box-shadow: 0 0 0 3px rgba(167,139,250,0.2); }
    button {
      background: linear-gradient(135deg, var(--primary), var(--accent));
      border: none;
      font-weight: 700;
      cursor: pointer;
    }
    button:hover { transform: translateY(-2px); box-shadow: 0 8px 20px rgba(167,139,250,0.3); }
    .card {
      background: var(--glass);
      backdrop-filter: blur(10px);
      -webkit-backdrop-filter: blur(10px);
      border: 1px solid var(--glass-border);
      border-radius: 16px;
      box-shadow: 0 12px 32px rgba(0,0,0,0.5);
      margin: 28px 0;
      overflow: hidden;
    }
    .card-header {
      background: linear-gradient(135deg, #1e1438, #2a1f45);
      padding: 16px;
      text-align: center;
      font-weight: 700;
      font-size: 1.3rem;
      color: var(--primary);
    }
    .summary-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(220px, 1fr));
      gap: 16px;
      padding: 20px;
    }
    .summary-item {
      background: rgba(50,40,80,0.5);
      border-radius: 12px;
      padding: 20px 16px;
      text-align: center;
      cursor: pointer;
      transition: all 0.25s;
      border: 1px solid rgba(167,139,250,0.15);
    }
    .summary-item:hover {
      transform: translateY(-6px) scale(1.04);
      box-shadow: 0 12px 30px rgba(0,0,0,0.4);
      background: rgba(60,50,90,0.7);
    }
    .summary-item strong { display: block; font-size: 1.6rem; margin: 8px 0; }
    .final-cash {
      font-size: 2.1rem;
      font-weight: 800;
      text-align: center;
      margin: 24px 0;
      padding: 20px;
      background: rgba(20,30,50,0.4);
      border-radius: 12px;
      border: 1px dashed var(--accent);
    }
    .profit-positive { color: var(--success); }
    .profit-negative { color: var(--danger); }

    table {
      width: 100%;
      border-collapse: separate;
      border-spacing: 0 8px;
      margin-top: 12px;
    }
    th, td { padding: 14px 16px; text-align: left; }
    th { background: rgba(50,40,80,0.7); color: var(--primary); font-weight: 600; }
    tr { background: var(--table); transition: 0.2s; }
    tr:hover { background: var(--hover); transform: scale(1.01); }

    .type-income { color: var(--success); font-weight: 600; }
    .type-expense, .type-in-shop-expenses, .type-missing { color: var(--danger); }
    .type-investment, .type-boc-deposit, .type-rdb-deposit { color: var(--warning); }

    #searchInput { width: 320px; max-width: 100%; }
    #exportBtn { background: linear-gradient(135deg, #10b981, #34d399); }

    #chartContainer { display: grid; grid-template-columns: 1fr 1fr; gap: 24px; padding: 20px; }
    #chartContainer > div { height: 420px; }
    @media (max-width: 900px) { #chartContainer { grid-template-columns: 1fr; } }

    #loader {
      position: fixed; inset: 0;
      background: var(--bg);
      display: flex; flex-direction: column;
      align-items: center; justify-content: center;
      font-size: 2.5rem; color: var(--primary);
      z-index: 9999;
    }
    .spinner {
      width: 80px; height: 80px;
      border: 10px solid var(--primary);
      border-top: 10px solid transparent;
      border-radius: 50%;
      animation: spin 1s linear infinite;
      margin-top: 24px;
    }
    @keyframes spin { to { transform: rotate(360deg); } }

    #detailModal, #formModal {
      display: none;
      position: fixed; inset: 0;
      background: rgba(0,0,0,0.8);
      z-index: 10000;
      align-items: center; justify-content: center;
      backdrop-filter: blur(4px);
    }
    #detailContent, #formModal > div {
      background: var(--card);
      border-radius: 16px;
      width: 92%; max-width: 820px;
      max-height: 88vh;
      overflow-y: auto;
      padding: 24px;
      position: relative;
      box-shadow: 0 20px 60px rgba(0,0,0,0.6);
      border: 1px solid var(--border);
    }
    .close-btn {
      position: absolute; top: 12px; right: 20px;
      font-size: 42px; color: var(--danger);
      cursor: pointer; font-weight: bold;
    }
  </style>
</head>
<body>
<div id="loader">KC Money Management<br><div class="spinner"></div></div>

<div class="container">
  <header><h1>KC Money Management</h1></header>

  <div class="controls">
    <select id="day"></select>
    <input type="text" id="searchInput" placeholder="Search description..." />
    <button onclick="document.getElementById('formModal').style.display='flex'">+ Add Entry</button>
    <button id="exportBtn">Export CSV</button>
  </div>

  <div id="formModal">
    <div>
      <span class="close-btn" onclick="document.getElementById('formModal').style.display='none'">√ó</span>
      <iframe src="./form.html" style="width:100%; height:100%; border:none;"></iframe>
    </div>
  </div>

  <div id="monthlyProfit" class="card" style="display:none">
    <div class="card-header">Monthly Summary</div>
    <div class="card-body">
      <div class="summary-grid" id="summaryGrid"></div>
      <div class="final-cash" id="finalCash"></div>
    </div>
  </div>

  <div id="chartsSection" class="card" style="display:none">
    <div class="card-header">Trends & Breakdown</div>
    <div id="chartContainer">
      <div><canvas id="profitChart"></canvas></div>
      <div><canvas id="pieChart"></canvas></div>
    </div>
  </div>

  <div class="card" id="dailySection" style="display:none">
    <div class="card-header">Daily Entries</div>
    <div class="card-body">
      <table id="dailyTable">
        <thead><tr><th>Date</th><th>Desc</th><th>Type</th><th>Amt (Rs.)</th></tr></thead>
        <tbody></tbody>
      </table>
    </div>
  </div>

  <div id="dayBalance" style="display:none; text-align:center; font-size:1.6rem; margin:32px 0; font-weight:700;"></div>
</div>

<!-- Detail Modal -->
<div id="detailModal">
  <div id="detailContent">
    <span class="close-btn" onclick="document.getElementById('detailModal').style.display='none'">√ó</span>
    <h2 id="detailTitle" style="margin:0 0 20px; color:var(--primary);"></h2>
    <table id="detailTable">
      <thead><tr><th>Date</th><th>Desc</th><th>Amt</th></tr></thead>
      <tbody></tbody>
    </table>
  </div>
</div>

<script>
// ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
const data = [];
let profitChart = null, pieChart = null;

fetch("https://opensheet.elk.sh/1liis-IfyE7n9yeJV5osfqaRz0MMTz0UY9ijv3x5vEk8/ABC")
  .then(r => r.json())
  .then(rows => {
    rows.forEach(r => {
      const date = (r.Date || r.date || "").trim();
      const amt = Number(r["Amount (Rs.)"] || r.amount || 0);
      if (date && !isNaN(amt)) {
        data.push({
          date,
          desc: (r.Description || r.description || "").trim(),
          type: (r.Type || r.type || "").trim(),
          amount: amt
        });
      }
    });
    data.sort((a,b) => new Date(a.date) - new Date(b.date));
    document.getElementById("loader").style.display = "none";
    init();
  });

// ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function init() {
  const s = document.getElementById("day");
  const dates = [...new Set(data.map(r => r.date))].sort((a,b) => new Date(b) - new Date(a));
  dates.forEach(d => s.add(new Option(d, d)));
  if (dates.length) s.value = dates[0];

  s.onchange = updateView;
  document.getElementById("searchInput").oninput = updateView;
  document.getElementById("exportBtn").onclick = exportCSV;

  updateView();
}

function updateView() {
  const selectedDate = document.getElementById("day").value;
  const searchTerm = document.getElementById("searchInput").value.toLowerCase().trim();

  if (!selectedDate) return;

  // Daily table + search filter
  const tb = document.querySelector("#dailyTable tbody");
  tb.innerHTML = "";
  const dayEntries = data.filter(r => r.date === selectedDate);
  const filtered = searchTerm
    ? dayEntries.filter(r => r.desc.toLowerCase().includes(searchTerm) || r.type.toLowerCase().includes(searchTerm))
    : dayEntries;

  let net = 0;
  filtered.forEach(i => {
    const typeClass = `type-${i.type.toLowerCase().replace(/\s+/g, "-")}`;
    tb.innerHTML += `
      <tr>
        <td>${i.date}</td>
        <td>${i.desc || "‚Äî"}</td>
        <td class="${typeClass}">${i.type}</td>
        <td class="${typeClass}">${i.amount.toLocaleString('si-LK', {minimumFractionDigits:2})}</td>
      </tr>`;
    net += i.type === "Income" ? i.amount : (["Expenses","In-shop Expenses","Missing","BOC Deposit","RDB Deposit","Investment"].includes(i.type) ? -i.amount : 0);
  });

  const balanceEl = document.getElementById("dayBalance");
  balanceEl.textContent = `${selectedDate} ‡∂Ö‡∑Ä‡∑É‡∑è‡∂± ‡∂Ω‡∑è‡∂∑‡∂∫: Rs. ${net.toLocaleString('si-LK', {minimumFractionDigits:2})}`;
  balanceEl.className = net >= 0 ? "profit-positive" : "profit-negative";
  balanceEl.style.display = filtered.length ? "block" : "none";
  document.getElementById("dailySection").style.display = filtered.length ? "block" : "none";

  // ‚îÄ‚îÄ Monthly / Cumulative ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
  const upToDate = new Date(selectedDate);
  const past = data.filter(r => new Date(r.date) <= upToDate);

  if (!past.length) {
    document.getElementById("monthlyProfit").style.display = "block";
    document.getElementById("monthlyProfit").innerHTML = '<div style="padding:80px;text-align:center;color:#777">No data yet...</div>';
    return;
  }

  const months = past.reduce((o, r) => {
    const k = r.date.slice(0,7);
    o[k] = (o[k] || []).concat(r);
    return o;
  }, {});

  const monthKeys = Object.keys(months).sort();
  let carryOver = 0;
  let previousMonth = "";

  monthKeys.slice(0, -1).forEach(k => {
    carryOver += monthNet(months[k]);
    previousMonth = k;
  });

  const currentMonth = months[monthKeys.at(-1)];
  const handCash = carryOver + monthNet(currentMonth);

  // Summary grid
  const grid = document.getElementById("summaryGrid");
  grid.innerHTML = `
    ${previousMonth ? `
    <div class="summary-item" data-category="carry" data-prev="${previousMonth}" data-carry="${carryOver}">
      <div>Carry Forward (${previousMonth})</div>
      <strong style="color:#a5b4fc">Rs.${carryOver.toLocaleString('si-LK', {minimumFractionDigits:2})}</strong>
    </div>` : ""}
    <div class="summary-item" data-category="Income">
      <div>üí∞ Income</div><strong class="profit-positive">Rs.${byType(currentMonth,'Income').toLocaleString('si-LK', {minimumFractionDigits:2})}</strong>
    </div>
    <div class="summary-item" data-category="Expenses">
      <div>üí∏ Expenses</div><strong style="color:var(--danger)">Rs.${byType(currentMonth,['Expenses','In-shop Expenses']).toLocaleString('si-LK', {minimumFractionDigits:2})}</strong>
    </div>
    <div class="summary-item" data-category="Missing">
      <div>‚ö†Ô∏è Missing</div><strong style="color:var(--warning)">Rs.${byType(currentMonth,'Missing').toLocaleString('si-LK', {minimumFractionDigits:2})}</strong>
    </div>
    <div class="summary-item" data-category="Investment">
      <div>üìà Investment</div><strong style="color:var(--warning)">Rs.${byType(currentMonth,'Investment').toLocaleString('si-LK', {minimumFractionDigits:2})}</strong>
    </div>
    <div class="summary-item" data-category="BOC/RDB Deposit">
      <div>üè¶ BOC/RDB</div><strong style="color:var(--info)">Rs.${byType(currentMonth,['BOC Deposit','RDB Deposit']).toLocaleString('si-LK', {minimumFractionDigits:2})}</strong>
    </div>
  `;

  document.querySelectorAll('.summary-item').forEach(el => {
    el.onclick = () => {
      const cat = el.dataset.category;
      let items = [];
      if (cat === "carry") {
        const endPrev = new Date(previousMonth + "-01");
        endPrev.setMonth(endPrev.getMonth());
        endPrev.setDate(0);
        items = past.filter(r => new Date(r.date) <= endPrev);
      } else if (cat === "Expenses") {
        items = past.filter(r => ['Expenses','In-shop Expenses'].includes(r.type));
      } else if (cat === "BOC/RDB Deposit") {
        items = past.filter(r => ['BOC Deposit','RDB Deposit'].includes(r.type));
      } else {
        items = past.filter(r => r.type === cat);
      }
      showDetail(cat === "carry" ? `Carry forward (${previousMonth})` : cat, items);
    };
  });

  const finalEl = document.getElementById("finalCash");
  finalEl.innerHTML = `Hand Cash: <span class="${handCash >= 0 ? 'profit-positive' : 'profit-negative'}">Rs.${handCash.toLocaleString('si-LK', {minimumFractionDigits:2})}</span>`;
  document.getElementById("monthlyProfit").style.display = "block";

  // ‚îÄ‚îÄ Charts ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
  updateCharts(past, currentMonth);
  document.getElementById("chartsSection").style.display = "block";
}

function updateCharts(allData, currentMonthData) {
  // Cumulative + Daily line chart
  const dailyNet = allData.reduce((o,r) => {
    const sign = r.type==="Income" ? 1 : (["Expenses","In-shop Expenses","Missing","BOC Deposit","RDB Deposit","Investment"].includes(r.type) ? -1 : 0);
    o[r.date] = (o[r.date] || 0) + sign * r.amount;
    return o;
  }, {});

  const labels = Object.keys(dailyNet).sort();
  const dailyValues = labels.map(k => dailyNet[k]);
  let cumulative = 0;
  const cumValues = dailyValues.map(v => cumulative += v);

  if (profitChart) {
    profitChart.data.labels = labels;
    profitChart.data.datasets[0].data = cumValues;
    profitChart.data.datasets[1].data = dailyValues;
    profitChart.update();
  } else {
    profitChart = new Chart(document.getElementById("profitChart"), {
      type: "line",
      data: {
        labels,
        datasets: [
          { label: "Cumulative", data: cumValues, borderColor: "#a78bfa", backgroundColor: "rgba(167,139,250,0.15)", fill: true, tension: 0.35, yAxisID: "y" },
          { label: "Daily Net", data: dailyValues, borderColor: "#f472b6", borderDash: [6,4], tension: 0.28, yAxisID: "y1" }
        ]
      },
      options: {
        responsive: true,
        maintainAspectRatio: false,
        plugins: { legend: { position: "top", labels: { color: "#d1d5db" } } },
        scales: {
          x: { ticks: { color: "#b0a0d0" } },
          y: { position: "left", title: { display: true, text: "Cumulative (Rs.)", color: "#d1d5db" }, ticks: { color: "#b0a0d0" } },
          y1: { position: "right", title: { display: true, text: "Daily Net", color: "#d1d5db" }, grid: { drawOnChartArea: false }, ticks: { color: "#b0a0d0" } }
        }
      }
    });
  }

  // Pie chart - Current month category breakdown
  const catSums = {};
  currentMonthData.forEach(r => {
    const t = r.type;
    catSums[t] = (catSums[t] || 0) + (["Income"].includes(t) ? r.amount : -r.amount);
  });

  const pieData = Object.entries(catSums).map(([label, value]) => ({label, value: Math.abs(value)}));
  const pieColors = ["#34d399","#f87171","#fbbf24","#60a5fa","#a78bfa","#f472b6","#ec4899"];

  if (pieChart) {
    pieChart.data.labels = pieData.map(d => d.label);
    pieChart.data.datasets[0].data = pieData.map(d => d.value);
    pieChart.update();
  } else {
    pieChart = new Chart(document.getElementById("pieChart"), {
      type: "doughnut",
      data: {
        labels: pieData.map(d => d.label),
        datasets: [{
          data: pieData.map(d => d.value),
          backgroundColor: pieColors,
          borderColor: "rgba(30,20,60,0.8)",
          borderWidth: 2
        }]
      },
      options: {
        responsive: true,
        maintainAspectRatio: false,
        plugins: {
          legend: { position: "bottom", labels: { color: "#d1d5db", padding: 16 } },
          title: { display: true, text: "Current Month Breakdown", color: "#f0eaff", font: { size: 16 } }
        },
        cutout: "60%"
      }
    });
  }
}

function showDetail(title, items) {
  document.getElementById("detailTitle").textContent = title;
  const tb = document.querySelector("#detailTable tbody");
  tb.innerHTML = items.map(r => `
    <tr>
      <td>${r.date}</td>
      <td>${r.desc || "‚Äî"}</td>
      <td>${r.amount.toLocaleString('si-LK', {minimumFractionDigits:2})}</td>
    </tr>`).join("");
  document.getElementById("detailModal").style.display = "flex";
}

function byType(items, types) {
  const t = [].concat(types);
  return items.filter(r => t.includes(r.type)).reduce((s, r) => s + r.amount, 0);
}

function monthNet(items) {
  return byType(items, "Income") -
         byType(items, ["Expenses", "In-shop Expenses"]) -
         byType(items, "Missing") -
         byType(items, ["BOC Deposit", "RDB Deposit"]) -
         byType(items, "Investment");
}

function exportCSV() {
  const selectedDate = document.getElementById("day").value;
  if (!selectedDate) return alert("‡∂ö‡∂ª‡∑î‡∂´‡∑è‡∂ö‡∂ª ‡∂Ø‡∑Ä‡∑É‡∂ö‡∑ä ‡∂≠‡∑ù‡∂ª‡∂±‡∑ä‡∂±");

  const month = selectedDate.slice(0,7);
  const monthData = data.filter(r => r.date.startsWith(month));

  if (!monthData.length) return alert("‡∂∏‡∑ö ‡∂∏‡∑è‡∑É‡∂∫‡∑ö data ‡∂±‡∑ê‡∑Ñ‡∑ê");

  let csv = "Date,Description,Type,Amount (Rs.)\n";
  monthData.forEach(r => {
    csv += `"${r.date}","${r.desc.replace(/"/g,'""')}","${r.type}",${r.amount}\n`;
  });

  const blob = new Blob([csv], { type: "text/csv;charset=utf-8;" });
  const url = URL.createObjectURL(blob);
  const link = document.createElement("a");
  link.href = url;
  link.download = `KC_Money_${month}.csv`;
  link.click();
  URL.revokeObjectURL(url);
}
</script>
</body>
</html>
